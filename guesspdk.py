#!/usr/bin/env python3

pdk_data = [
  ('sky130A', {
    (0, 0), (0, 4), (0, 5), (0, 10), (0, 13), (0, 14), (0, 15), (0, 16), (0, 17), (0, 20), (0, 21), (0, 22), (0, 23),
    (0, 25), (0, 32), (0, 33), (0, 34), (0, 35), (0, 36), (0, 37), (0, 38), (0, 39), (0, 41), (0, 44), (0, 48), (0, 60),
    (0, 88), (0, 89), (0, 90), (0, 91), (0, 92), (0, 93), (1, 0), (1, 1), (1, 2), (1, 3), (1, 4), (1, 5), (1, 6), (1, 7),
    (1, 8), (1, 10), (1, 11), (1, 12), (1, 13), (1, 14), (1, 15), (1, 16), (1, 17), (1, 19), (1, 20), (1, 21), (1, 22),
    (1, 23), (1, 25), (1, 27), (1, 28), (1, 32), (1, 33), (1, 34), (1, 35), (1, 36), (1, 37), (1, 38), (1, 39), (1, 41),
    (1, 42), (1, 43), (1, 44), (1, 48), (1, 50), (1, 51), (1, 52), (1, 53), (1, 54), (1, 57), (1, 60), (1, 63), (1, 79),
    (1, 81), (1, 88), (1, 89), (1, 90), (1, 91), (1, 92), (1, 93), (1, 101), (1, 125), (2, 0), (2, 4), (2, 5), (2, 10),
    (2, 13), (2, 14), (2, 15), (2, 16), (2, 17), (2, 20), (2, 21), (2, 22), (2, 23), (2, 24), (2, 25), (2, 26), (2, 27),
    (2, 28), (2, 32), (2, 33), (2, 34), (2, 35), (2, 36), (2, 37), (2, 38), (2, 39), (2, 42), (2, 43), (2, 44), (2, 59),
    (2, 64), (2, 88), (2, 89), (2, 90), (2, 91), (2, 92), (2, 93), (3, 0), (3, 24), (3, 28), (3, 42), (3, 43), (3, 44),
    (4, 0), (4, 5), (4, 13), (4, 14), (4, 15), (4, 16), (4, 18), (4, 20), (4, 21), (4, 22), (4, 23), (4, 28), (4, 40),
    (4, 42), (4, 43), (4, 44), (4, 59), (4, 88), (4, 89), (4, 90), (4, 91), (4, 92), (4, 93), (5, 0), (5, 4), (5, 5),
    (5, 6), (5, 8), (5, 13), (5, 14), (5, 16), (5, 20), (5, 21), (5, 22), (5, 23), (5, 41), (5, 42), (5, 43), (5, 44),
    (5, 48), (5, 52), (5, 60), (5, 250), (5, 252), (6, 0), (6, 4), (6, 5), (6, 9), (6, 13), (6, 14), (6, 15), (6, 16),
    (6, 20), (6, 21), (6, 22), (6, 23), (6, 25), (6, 28), (6, 41), (6, 42), (6, 43), (6, 44), (6, 58), (6, 60), (6, 83),
    (7, 0), (7, 4), (7, 5), (7, 10), (7, 13), (7, 14), (7, 15), (7, 16), (7, 20), (7, 21), (7, 22), (7, 23), (7, 24),
    (7, 25), (7, 41), (7, 42), (7, 43), (7, 44), (7, 48), (7, 60), (8, 0), (8, 4), (8, 5), (8, 10), (8, 13), (8, 14),
    (8, 15), (8, 16), (8, 20), (8, 21), (8, 22), (8, 23), (8, 25), (8, 28), (8, 32), (8, 33), (8, 34), (8, 35), (8, 36),
    (8, 37), (8, 38), (8, 39), (8, 41), (8, 42), (8, 43), (8, 44), (8, 58), (8, 60), (8, 88), (8, 89), (8, 90), (8, 91),
    (8, 92), (8, 93), (9, 0), (9, 4), (9, 5), (9, 10), (9, 13), (9, 14), (9, 15), (9, 16), (9, 20), (9, 21), (9, 22),
    (9, 23), (9, 25), (9, 28), (9, 32), (9, 33), (9, 34), (9, 35), (9, 36), (9, 37), (9, 38), (9, 39), (9, 41), (9, 42),
    (9, 43), (9, 44), (9, 58), (9, 60), (9, 88), (9, 89), (9, 90), (9, 91), (9, 92), (9, 93), (10, 0), (11, 0), (11, 44),
    (18, 20), (20, 0), (21, 0), (22, 0), (22, 22), (22, 24), (23, 0), (23, 28), (25, 0), (27, 0), (28, 0), (28, 28),
    (30, 0), (32, 0), (33, 24), (34, 0), (34, 28), (35, 0), (36, 0), (36, 28), (37, 0), (39, 0), (40, 0), (41, 0), (41, 28),
    (43, 0), (44, 0), (46, 0), (48, 0), (49, 0), (50, 0), (51, 0), (51, 28), (56, 0), (56, 28), (58, 0), (59, 0), (59, 28),
    (61, 20), (62, 24), (64, 5), (64, 13), (64, 16), (64, 18), (64, 20), (64, 59), (65, 5), (65, 6), (65, 13), (65, 14),
    (65, 16), (65, 20), (65, 44), (65, 98), (66, 5), (66, 9), (66, 13), (66, 14), (66, 15), (66, 16), (66, 20), (66, 44),
    (66, 83), (67, 5), (67, 13), (67, 15), (67, 16), (67, 20), (67, 44), (67, 98), (68, 5), (68, 13), (68, 15), (68, 16),
    (68, 20), (68, 44), (68, 98), (69, 5), (69, 13), (69, 15), (69, 16), (69, 20), (69, 44), (69, 98), (70, 5), (70, 13),
    (70, 15), (70, 16), (70, 20), (70, 44), (70, 98), (71, 5), (71, 13), (71, 15), (71, 16), (71, 20), (71, 44), (71, 98),
    (72, 5), (72, 10), (72, 13), (72, 15), (72, 16), (72, 20), (72, 98), (74, 5), (74, 16), (74, 20), (75, 20), (76, 5),
    (76, 16), (76, 20), (78, 44), (79, 20), (80, 20), (81, 1), (81, 2), (81, 3), (81, 4), (81, 6), (81, 8), (81, 14),
    (81, 19), (81, 20), (81, 23), (81, 51), (81, 52), (81, 53), (81, 57), (81, 60), (81, 63), (81, 81), (82, 20), (82, 44),
    (82, 64), (83, 44), (86, 20), (88, 0), (89, 44), (93, 44), (94, 20), (95, 20), (96, 0), (97, 0), (97, 44), (98, 0),
    (105, 52), (107, 24), (112, 4), (117, 4), (122, 16), (125, 20), (125, 44), (235, 4), (236, 0),
  }),
  ('gf180mcuD', {
    (0, 0), (0, 4), (0, 5), (0, 7), (0, 8), (0, 10), (0, 11), (0, 12), (0, 13), (0, 14), (0, 15), (0, 16), (1, 0), (1, 3),
    (1, 4), (1, 5), (1, 10), (1, 17), (1, 39), (1, 222), (2, 0), (2, 1), (2, 3), (2, 4), (2, 5), (2, 10), (2, 222),
    (3, 0), (3, 3), (3, 4), (3, 5), (3, 10), (3, 17), (3, 51), (3, 222), (4, 0), (4, 3), (4, 4), (4, 5), (4, 10),
    (4, 222), (5, 0), (5, 5), (5, 222), (6, 0), (6, 1), (6, 3), (6, 4), (6, 5), (6, 10), (6, 17), (6, 222), (7, 0),
    (7, 5), (7, 10), (8, 0), (8, 5), (8, 17), (9, 0), (9, 5), (11, 39), (12, 0), (21, 0), (21, 10), (22, 0), (22, 4),
    (23, 5), (24, 5), (30, 0), (30, 4), (30, 10), (31, 0), (32, 0), (33, 0), (34, 0), (34, 4), (34, 5), (34, 10), (35, 0),
    (36, 0), (36, 4), (36, 5), (36, 10), (37, 0), (38, 0), (40, 0), (41, 0), (42, 0), (42, 4), (42, 5), (42, 10), (46, 0),
    (46, 4), (46, 5), (46, 10), (49, 0), (55, 0), (58, 0), (62, 0), (63, 0), (63, 63), (75, 0), (80, 5), (81, 0), (81, 4),
    (81, 5), (81, 10), (100, 8), (108, 5), (110, 5), (110, 11), (110, 12), (110, 13), (110, 14), (110, 15), (111, 5),
    (112, 1), (115, 5), (117, 5), (117, 10), (118, 5), (119, 5), (125, 5), (127, 5), (137, 5), (152, 5), (166, 5),
    (167, 5), (204, 0), (204, 10), (210, 0), (230, 0), (230, 1), (230, 5), (230, 10), (241, 0)
  }),
  ('ihp-sg13g2', {
    (1, 0), (1, 1), (1, 2), (1, 3), (1, 4), (1, 19), (1, 20), (1, 22), (1, 23), (1, 26), (1, 27), (1, 28), (3, 0),
    (3, 26), (5, 0), (5, 1), (5, 2), (5, 3), (5, 4), (5, 22), (5, 23), (5, 26), (5, 27), (5, 28), (6, 0), (6, 3), (6, 4),
    (6, 26), (7, 0), (7, 21), (8, 0), (8, 1), (8, 2), (8, 3), (8, 4), (8, 20), (8, 22), (8, 23), (8, 24), (8, 25),
    (8, 26), (8, 28), (8, 29), (8, 33), (8, 34), (9, 0), (9, 1), (9, 2), (9, 3), (9, 4), (9, 35), (9, 36), (9, 40),
    (10, 0), (10, 1), (10, 2), (10, 3), (10, 4), (10, 20), (10, 22), (10, 23), (10, 24), (10, 25), (10, 26), (10, 28),
    (10, 29), (10, 33), (10, 34), (13, 0), (13, 1), (13, 2), (13, 3), (13, 4), (14, 0), (15, 0), (16, 0), (16, 10),
    (19, 0), (19, 3), (19, 4), (20, 0), (20, 1), (20, 2), (20, 3), (20, 4), (20, 20), (20, 22), (20, 23), (20, 24),
    (20, 25), (20, 26), (20, 28), (20, 29), (20, 33), (20, 34), (23, 0), (24, 0), (24, 1), (25, 0), (25, 1), (25, 4),
    (26, 0), (27, 0), (27, 2), (27, 4), (27, 25), (28, 0), (29, 0), (29, 3), (29, 4), (30, 0), (30, 1), (30, 2), (30, 3),
    (30, 4), (30, 20), (30, 22), (30, 23), (30, 24), (30, 25), (30, 26), (30, 28), (30, 29), (30, 33), (30, 34), (31, 0),
    (31, 1), (31, 2), (31, 3), (31, 4), (32, 0), (32, 1), (32, 2), (32, 3), (32, 4), (32, 21), (33, 0), (33, 26),
    (35, 0), (36, 0), (36, 3), (36, 4), (39, 0), (39, 4), (40, 0), (40, 25), (41, 0), (41, 35), (41, 36), (44, 0),
    (45, 0), (46, 0), (46, 1), (46, 2), (46, 3), (46, 4), (46, 21), (48, 0), (49, 0), (49, 3), (49, 4), (50, 0), (50, 1),
    (50, 2), (50, 3), (50, 4), (50, 20), (50, 22), (50, 23), (50, 24), (50, 25), (50, 26), (50, 28), (50, 29), (50, 33),
    (50, 34), (51, 0), (52, 0), (54, 0), (55, 0), (60, 0), (62, 0), (63, 0), (66, 0), (66, 3), (66, 4), (67, 0), (67, 1),
    (67, 2), (67, 3), (67, 4), (67, 20), (67, 22), (67, 23), (67, 24), (67, 25), (67, 26), (67, 28), (67, 29), (67, 33),
    (67, 34), (68, 0), (69, 0), (70, 0), (72, 0), (73, 0), (74, 0), (75, 0), (76, 0), (77, 0), (78, 0), (79, 0), (83, 0),
    (84, 0), (85, 0), (86, 0), (86, 22), (86, 23), (87, 0), (88, 0), (89, 0), (90, 0), (91, 0), (92, 0), (93, 0),
    (97, 0), (98, 0), (98, 1), (98, 2), (98, 3), (99, 0), (99, 2), (99, 30), (99, 31), (99, 32), (99, 33), (99, 34),
    (99, 35), (99, 36), (99, 37), (99, 38), (99, 39), (99, 100), (101, 0), (109, 0), (109, 22), (109, 23), (109, 24),
    (109, 26), (110, 0), (110, 22), (110, 23), (110, 24), (110, 26), (111, 0), (112, 0), (113, 0), (114, 0), (115, 0),
    (116, 0), (117, 0), (118, 0), (119, 0), (119, 22), (119, 23), (124, 0), (125, 0), (125, 3), (125, 4), (126, 0),
    (126, 1), (126, 2), (126, 3), (126, 4), (126, 20), (126, 22), (126, 23), (126, 24), (126, 25), (126, 28), (126, 29),
    (126, 33), (126, 34), (127, 0), (128, 0), (128, 1), (128, 2), (128, 3), (128, 4), (129, 0), (131, 0), (132, 0),
    (133, 0), (133, 3), (133, 4), (134, 0), (134, 1), (134, 2), (134, 3), (134, 4), (134, 20), (134, 22), (134, 23),
    (134, 24), (134, 25), (134, 28), (134, 29), (134, 33), (134, 34), (135, 0), (136, 0), (137, 0), (138, 0), (139, 0),
    (142, 0), (143, 0), (145, 0), (146, 0), (147, 0), (148, 0), (148, 41), (148, 42), (148, 43), (148, 44), (148, 45),
    (148, 46), (148, 47), (148, 48), (148, 49), (148, 50), (148, 51), (148, 52), (148, 53), (148, 54), (148, 55),
    (148, 123), (148, 124), (148, 125), (148, 126), (148, 127), (148, 300), (148, 301), (149, 0), (151, 0), (152, 0),
    (153, 0), (154, 0), (155, 0), (156, 0), (157, 0), (159, 0), (160, 0), (189, 0), (189, 1), (189, 4), (190, 0),
    (190, 1), (190, 2), (190, 25), (191, 0), (191, 1), (191, 2), (191, 25), (192, 0), (192, 1), (192, 2), (192, 25),
    (193, 0), (193, 1), (193, 2), (193, 25), (194, 0), (194, 1), (194, 2), (194, 25), (235, 4), (257, 0),
  }),
]


if __name__ == '__main__':
    import sys
    
    #import gdstk
    #lib = gdstk.read_gds(sys.argv[1])
    #ld = lib.layers_and_datatypes()

    import klayout.db as db
    ly = db.Layout()
    ly.read(sys.argv[1])
    ld = {(l.layer, l.datatype) for l in ly.layer_infos()}
    
    guesses = []
    for pdk, valid_ld in pdk_data:
        if ld.issubset(valid_ld):
            guesses.append(pdk)

    if len(guesses) == 1:
        print(guesses[0])
    elif guesses:
        gj = ", ".join(guesses)
        print(f"Multiple matching PDKs: {gj}", file=sys.stderr)
        exit(1)
    else:
        print("No matching PDK", file=sys.stderr)
        for pdk, valid_ld in pdk_data:
            lj = ", ".join(str(i) for i in sorted(ld-valid_ld))
            print(f"Invalid layers for {pdk}: {lj}", file=sys.stderr)
        exit(1)

